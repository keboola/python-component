name: Build & Deploy to PyPI

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment environment
        required: true
        type: choice
        options:
          - test
          - production

  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›’
        uses: actions/checkout@v4

      - name: Install uv ğŸ’œ
        uses: astral-sh/setup-uv@v6

      - name: Install and run ruff ğŸ¶
        uses: astral-sh/ruff-action@v3

      - name: Set up Python ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies ğŸ“¦
        run: |
          uv sync --all-groups --frozen

      - name: Lint with flake8 â„ï¸
        run: |
          uv run flake8

      - name: Test with pytest âœ…
        run: |
          uv run pytest tests

      - name: Version replacement based on tag â†”ï¸
        if: github.ref_type == 'tag'
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          echo "Tag version: $TAG_VERSION"
          uv version $TAG_VERSION

      - name: Generate HTML documentation ğŸ“š
        if: github.event_name == 'release' || inputs.environment == 'production'
        run: |
          uv sync --all-groups --frozen
          uv pip install -e .
          uv run pdoc --html -f -o ./docs keboola.component
          mv ./docs/keboola/component/* docs
          rm -r ./docs/keboola

      - name: Build package ğŸ“¦
        run: |
          uv build

      - name: Publish to PyPI ğŸš€
        env:
          UV_PUBLISH_TOKEN: ${{ inputs.environment == 'test' && secrets.UV_PUBLISH_TOKEN_TEST_PYPI || secrets.UV_PUBLISH_TOKEN }}
        run: |
          uv publish ${{ inputs.environment == 'test' && '--index testpypi' || '' }}

      - name: Commit documentation ğŸ“
        if: github.event_name == 'release' || inputs.environment == 'production'
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          git config --global user.name 'KCF'
          git config --global user.email 'kcf@users.noreply.github.com'
          git add docs
          git commit -m "docs: update for release $TAG_VERSION ğŸ“š" || echo "No changes to commit"
          git push
